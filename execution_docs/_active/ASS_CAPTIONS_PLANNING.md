# ASS Captions Implementation - Planning Doc

**Date**: 2026-02-10
**Scope**: Full TikTok-style caption system with Advanced SubStation Alpha (ASS) format
**Approach**: Option B - Full implementation with all presets and LLM focus words
**Estimated Time**: 8-10 hours

---

## üéØ Objective

Replace/supplement basic SRT captions with **ASS (Advanced SubStation Alpha)** format to enable:
- ‚úÖ Word-by-word karaoke highlighting (TikTok style)
- ‚úÖ Custom styling (fonts, colors, outlines, shadows)
- ‚úÖ Focus word emphasis (LLM-detected important words)
- ‚úÖ Multiple style presets (TikTok, Instagram, YouTube)
- ‚úÖ Full FFmpeg compatibility

---

## üìä Current State vs Target State

### Current (SRT Only)
```srt
1
00:00:00,031 --> 00:00:03,297
My 46F daughters, 17 and

2
00:00:03,317 --> 00:00:05,601
15, have a strained relationship
```

**Limitations**:
- ‚ùå No word-level highlighting
- ‚ùå Limited styling (basic colors only)
- ‚ùå No animations
- ‚ùå Can't emphasize specific words

### Target (ASS with Karaoke)
```ass
[V4+ Styles]
Style: TikTok,Impact,52,&H00FFFF00,&H00FFFF00,&H00000000,&H80000000,-1,-1,0,0,100,100,0,0,1,3,2,2,10,10,20,1
Style: Focus,Impact,68,&H0000FFFF,&H0000FFFF,&H00000000,&HC0000000,-1,-1,0,0,120,120,0,0,1,4,3,2,10,10,20,1

[Events]
Dialogue: 0,0:00:00.03,0:00:00.27,TikTok,,0,0,0,,{\k24}My {\k82}46F {\k48}daughters,
```

**Features**:
- ‚úÖ Word-by-word karaoke highlight (`\k` timing)
- ‚úÖ Custom styles (Impact font, yellow, black outline)
- ‚úÖ Focus word style (bigger, cyan, thicker outline)
- ‚úÖ Pixel-perfect positioning
- ‚úÖ FFmpeg native support

---

## üèóÔ∏è Architecture Overview

```
WhisperX Transcription (word timestamps)
           ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ             ‚îÇ
  SRT Gen      ASS Gen (NEW!)
    ‚îÇ             ‚îÇ
    ‚îú‚îÄ sentence   ‚îú‚îÄ tiktok preset
    ‚îú‚îÄ word       ‚îú‚îÄ instagram preset
    ‚îî‚îÄ karaoke    ‚îú‚îÄ youtube preset
                  ‚îú‚îÄ focus words
                  ‚îî‚îÄ custom styles
           ‚Üì
    Supabase Storage (both formats)
           ‚Üì
    UI Download Buttons
           ‚Üì
    FFmpeg Video Rendering (uses ASS)
```

---

## üìÅ File Structure

### New Files (3)
```
lib/captions/
‚îú‚îÄ‚îÄ srt-generator.ts              # Existing
‚îú‚îÄ‚îÄ ass-generator.ts              # NEW - Core ASS generation
‚îî‚îÄ‚îÄ ass-presets.ts                # NEW - Style presets

app/api/
‚îî‚îÄ‚îÄ llm/
    ‚îî‚îÄ‚îÄ focus-words/
        ‚îî‚îÄ‚îÄ route.ts              # NEW - LLM focus word detection
```

### Modified Files (2)
```
app/api/stt/transcribe/route.ts  # Add ASS generation
components/studio/CaptionPreview.tsx  # Add ASS preview/download
```

---

## üé® ASS Format Deep Dive

### ASS File Structure
```ass
[Script Info]
Title: Generated by Reel Story Studio
ScriptType: v4.00+

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: TikTok,Impact,52,&H00FFFF00,&H00FFFF00,&H00000000,&H80000000,-1,-1,0,0,100,100,0,0,1,3,2,2,10,10,20,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue: 0,0:00:00.03,0:00:07.04,TikTok,,0,0,0,,{\k24}My {\k82}46F {\k48}daughters
```

### Key ASS Tags
| Tag | Purpose | Example |
|-----|---------|---------|
| `\k<duration>` | Karaoke timing (centiseconds) | `{\k50}word` = 0.5s |
| `\fs<size>` | Font size | `{\fs64}BIG` |
| `\c&H<color>&` | Text color (BGR hex) | `{\c&H00FFFF&}` = yellow |
| `\3c&H<color>&` | Outline color | `{\3c&H000000&}` = black |
| `\bord<width>` | Outline width | `{\bord3}` = 3px |
| `\shad<offset>` | Shadow offset | `{\shad2}` = 2px |
| `\fscx<scale>` | Horizontal scale | `{\fscx120}` = 120% |
| `\fscy<scale>` | Vertical scale | `{\fscy120}` = 120% |

**Karaoke Effect**: ASS players automatically highlight each `\k` segment as it plays!

---

## üé≠ Style Presets Specification

### Preset 1: TikTok Style (Default)
```typescript
{
  name: 'TikTok',
  fontName: 'Impact',
  fontSize: 52,
  primaryColor: '&H00FFFF00', // Yellow (BGR)
  outlineColor: '&H00000000', // Black
  shadowColor: '&H80000000',  // Black 50% opacity
  bold: true,
  outline: 3,
  shadow: 2,
  alignment: 2, // Bottom-center
  marginV: 20,  // 20px from bottom
  karaokeFillColor: '&H0000FFFF', // Cyan for current word
}
```

**Effect**: Large yellow text, black outline, word-by-word yellow‚Üícyan highlight

### Preset 2: Instagram Reels
```typescript
{
  name: 'Instagram',
  fontName: 'Helvetica Neue Bold',
  fontSize: 44,
  primaryColor: '&H00FFFFFF', // White
  outlineColor: '&H00000000', // Black
  shadowColor: '&H80000000',
  bold: true,
  outline: 2,
  shadow: 1,
  alignment: 2, // Bottom-center
  marginV: 30,
  karaokeFillColor: '&H00FFFF00', // Yellow for current word
}
```

**Effect**: Clean white text, subtle outline, yellow highlight on current word

### Preset 3: YouTube Style
```typescript
{
  name: 'YouTube',
  fontName: 'Arial',
  fontSize: 40,
  primaryColor: '&H00FFFFFF', // White
  outlineColor: '&H00000000', // Black
  shadowColor: '&H80000000',
  bold: false,
  outline: 2,
  shadow: 0,
  alignment: 2, // Bottom-center
  marginV: 15,
  karaokeFillColor: '&H00FFFFFF', // No highlight (standard)
}
```

**Effect**: Standard readable captions, minimal styling

### Preset 4: Focus Word Emphasis (Overlay)
```typescript
{
  name: 'Focus',
  fontName: 'Impact',
  fontSize: 68,
  primaryColor: '&H0000FFFF', // Cyan (stands out)
  outlineColor: '&H00000000',
  shadowColor: '&HC0000000', // Darker shadow
  bold: true,
  outline: 4,
  shadow: 3,
  alignment: 2,
  marginV: 20,
  scaleX: 120, // 20% larger
  scaleY: 120,
}
```

**Effect**: Extra large, cyan, thick outline - used ONLY for LLM-detected focus words

---

## üß† LLM Focus Word Detection

### API Endpoint: `/api/llm/focus-words`

**Input**:
```json
{
  "text": "Full transcript text...",
  "maxWords": 10
}
```

**LLM Prompt**:
```
You are a video caption expert. Analyze this transcript and identify 5-10 KEY WORDS that should be visually emphasized in short-form video captions (TikTok/Reels style).

Focus on:
- Action words (verbs with impact)
- Emotional words (drama, surprise, intensity)
- Numbers (statistics, ages, quantities)
- Key nouns (central subjects)
- Punchline words (humor, twists)

Transcript:
{text}

Return ONLY a JSON array of objects with word text and 0-based word index:
[
  {"word": "strained", "index": 8, "reason": "emotional impact"},
  {"word": "cheating", "index": 35, "reason": "dramatic reveal"}
]
```

**Output**:
```json
{
  "focusWords": [
    {"word": "strained", "index": 8, "reason": "emotional impact"},
    {"word": "cheating", "index": 35, "reason": "dramatic reveal"},
    {"word": "orphaned", "index": 62, "reason": "high drama"}
  ]
}
```

**Integration**:
- Call LLM after WhisperX transcription
- Pass focus word indices to ASS generator
- Apply "Focus" style to those specific words

---

## üîß ASS Generator Implementation

### Core Function Signature
```typescript
interface ASSOptions {
  preset: 'tiktok' | 'instagram' | 'youtube' | 'custom'
  customStyle?: ASSStyle
  focusWords?: number[] // Word indices to emphasize
  wordsPerLine?: number // For grouping (default: 5)
  karaoke?: boolean // Enable karaoke effect (default: true)
}

function generateASS(
  transcription: TranscriptionResponse,
  options: ASSOptions
): string
```

### Algorithm: Karaoke Timing Conversion
```typescript
// WhisperX word: { word: "hello", start: 0.5, end: 1.0, score: 0.95 }
// ASS karaoke: {\k50}hello

// Duration in centiseconds (1/100 second)
const duration = Math.round((word.end - word.start) * 100)
const karaokeTiming = `{\\k${duration}}`

// Full word with timing
const assWord = `${karaokeTiming}${word.word}`
```

### Multi-Line Grouping
```typescript
// Group words into lines (5 words per line for readability)
const wordsPerLine = 5
const lines = []

for (let i = 0; i < allWords.length; i += wordsPerLine) {
  const lineWords = allWords.slice(i, i + wordsPerLine)
  const startTime = formatASSTime(lineWords[0].start)
  const endTime = formatASSTime(lineWords[lineWords.length - 1].end)

  // Build karaoke text
  const text = lineWords.map(w => {
    const isFocus = focusWords.includes(w.index)
    const duration = Math.round((w.end - w.start) * 100)

    if (isFocus) {
      // Apply focus style inline
      return `{\\fs68\\c&H0000FFFF&\\bord4\\k${duration}}${w.word}`
    } else {
      return `{\\k${duration}}${w.word}`
    }
  }).join(' ')

  lines.push(`Dialogue: 0,${startTime},${endTime},TikTok,,0,0,0,,${text}`)
}
```

---

## üì¶ Data Flow

```
1. User generates audio (TTS)
         ‚Üì
2. User clicks "Generate Captions"
         ‚Üì
3. Call /api/stt/transcribe
   ‚îú‚îÄ WhisperX transcription (word timestamps)
   ‚îú‚îÄ Generate SRT (existing)
   ‚îî‚îÄ Generate ASS (NEW)
         ‚Üì
4. [Optional] Call /api/llm/focus-words
   ‚îú‚îÄ LLM analyzes transcript
   ‚îî‚îÄ Returns focus word indices
         ‚Üì
5. Regenerate ASS with focus words
         ‚Üì
6. Upload to Supabase Storage:
   ‚îú‚îÄ {sessionId}/captions/{ts}.srt
   ‚îú‚îÄ {sessionId}/captions/{ts}.ass
   ‚îî‚îÄ {sessionId}/captions/{ts}.json (transcription)
         ‚Üì
7. Return URLs to UI
         ‚Üì
8. UI shows preview + download buttons
```

---

## üé® UI Updates

### CaptionPreview Component Changes

**Before** (SRT only):
```tsx
<Button onClick={downloadSRT}>
  Download SRT
</Button>
```

**After** (SRT + ASS + Presets):
```tsx
<div className="space-y-3">
  {/* Style Selector */}
  <Select value={selectedStyle} onValueChange={setSelectedStyle}>
    <option value="tiktok">üé¨ TikTok Style</option>
    <option value="instagram">üì∏ Instagram Reels</option>
    <option value="youtube">‚ñ∂Ô∏è YouTube</option>
  </Select>

  {/* Focus Words Toggle */}
  <Checkbox checked={useFocusWords} onChange={setUseFocusWords}>
    ‚ú® Emphasize key words (AI-detected)
  </Checkbox>

  {/* Download Buttons */}
  <div className="flex gap-2">
    <Button onClick={downloadSRT} variant="outline">
      Download SRT (compatibility)
    </Button>
    <Button onClick={downloadASS} variant="default">
      Download ASS (TikTok style) ‚≠ê
    </Button>
  </div>
</div>
```

**Preview Section**:
- Show first 3-5 caption lines
- Apply visual styling preview (simulate ASS appearance)
- Color-code focus words

---

## üöÄ Implementation Phases

### Phase 1: ASS Generator Core (3-4 hours)
- [ ] Create `lib/captions/ass-presets.ts`
  - Define TikTok, Instagram, YouTube presets
  - Color conversion utilities (RGB ‚Üî BGR hex)
  - Time formatting (seconds ‚Üí h:mm:ss.cc)

- [ ] Create `lib/captions/ass-generator.ts`
  - ASS file structure builder
  - Karaoke timing conversion
  - Style application
  - Multi-line grouping
  - Focus word emphasis

- [ ] Add tests (optional but recommended)
  - Test with real WhisperX data
  - Verify karaoke timing accuracy
  - Check color conversions

**Deliverable**: Generate ASS files from WhisperX transcriptions

---

### Phase 2: LLM Focus Word Detection (2-3 hours)
- [ ] Create `/api/llm/focus-words/route.ts`
  - Anthropic Claude API integration
  - Structured JSON output
  - Word index mapping
  - Error handling

- [ ] Add LLM prompt engineering
  - Test with various transcript types
  - Tune for short-form video (TikTok/Reels)
  - Handle edge cases (no focus words found)

- [ ] Add environment variable
  - `ANTHROPIC_API_KEY` to `.env.example`

**Deliverable**: LLM endpoint returns focus word indices

---

### Phase 3: API Integration (2 hours)
- [ ] Update `/api/stt/transcribe/route.ts`
  - Generate ASS in addition to SRT
  - Call LLM for focus words (optional flag)
  - Upload ASS to Supabase Storage
  - Return ASS URL

- [ ] Add request parameters
  - `captionStyle?: 'tiktok' | 'instagram' | 'youtube'`
  - `detectFocusWords?: boolean`

**Deliverable**: API returns both SRT and ASS URLs

---

### Phase 4: UI Updates (2-3 hours)
- [ ] Update `CaptionPreview` component
  - Add style selector dropdown
  - Add focus words checkbox
  - Add "Download ASS" button
  - Show style preview

- [ ] Update `TTSModule`
  - Add caption style selection BEFORE generation
  - Pass style to API

- [ ] Add visual preview
  - Simulate ASS styling in browser
  - Show focus words highlighted

**Deliverable**: Full caption generation UI with ASS support

---

## üß™ Testing Strategy

### Manual Testing Checklist
- [ ] Generate captions with TikTok preset
- [ ] Generate captions with Instagram preset
- [ ] Generate captions with YouTube preset
- [ ] Enable focus word detection
- [ ] Verify ASS file format (open in Aegisub or VSCode)
- [ ] Test FFmpeg rendering: `ffmpeg -i video.mp4 -vf "ass=captions.ass" output.mp4`
- [ ] Test both anonymous and authenticated users
- [ ] Verify localStorage persistence (anonymous)
- [ ] Verify Supabase upload (authenticated)

### Test Data
Use existing test file: `/Users/abhiroopprasad/Downloads/Reel Story Studio Voiceover.wav`
- 120 seconds duration
- 354 words
- Good for testing karaoke timing

---

## üìù Success Criteria

- [x] ASS generator produces valid ASS files
- [ ] Karaoke timing matches WhisperX word boundaries
- [ ] All 3 presets work correctly (TikTok, Instagram, YouTube)
- [ ] Focus words are correctly emphasized
- [ ] LLM detects 5-10 relevant focus words
- [ ] ASS files work in FFmpeg: `ffmpeg -i video.mp4 -vf "ass=captions.ass" output.mp4`
- [ ] ASS files open correctly in Aegisub (subtitle editor)
- [ ] UI allows selecting caption style
- [ ] Download buttons work for both SRT and ASS
- [ ] Anonymous users get data URLs (no Supabase upload)
- [ ] Authenticated users get Supabase Storage URLs

---

## üîí Security & Cost Considerations

### LLM API Costs
- **Anthropic Claude Haiku**: ~$0.25 per million input tokens
- **Average transcript**: ~500 tokens
- **Cost per request**: ~$0.0001 (negligible)
- **10,000 requests**: ~$1.00

**Mitigation**:
- Cache focus words in localStorage (anonymous)
- Cache in database (authenticated)
- Make focus word detection optional

### Rate Limiting
- LLM: 50 requests/min (Anthropic free tier)
- WhisperX: Already tested (3.4x faster than real-time)
- No additional limits needed

---

## üìä Performance Estimates

| Step | Duration | Notes |
|------|----------|-------|
| WhisperX Transcription | 10-40s | Already implemented |
| SRT Generation | <100ms | Already implemented |
| **ASS Generation** | **<200ms** | NEW - Fast (pure computation) |
| **LLM Focus Words** | **1-3s** | NEW - Optional |
| Upload to Supabase | 500ms-2s | Existing |
| **Total (with LLM)** | **12-45s** | Acceptable |

**Optimization**: Run LLM in parallel with ASS generation if no focus words initially.

---

## üéØ Future Enhancements

### Phase 5: Advanced Features (Future)
- [ ] Custom style editor (user-defined fonts/colors)
- [ ] Multiple ASS styles per video (mix presets)
- [ ] Animation effects (fade in, scale, bounce)
- [ ] Position customization (top, bottom, sides)
- [ ] Emoji support in captions
- [ ] Multi-language support (RTL text for Arabic, etc.)

### Phase 6: FFmpeg Auto-Rendering (Future)
- [ ] Automatic video generation with ASS captions
- [ ] Background asset selection + clipping
- [ ] FFmpeg job queue integration
- [ ] Progress tracking
- [ ] Final MP4 download

---

## ü§î Open Questions

1. **LLM Provider**: Use Anthropic Claude or OpenAI GPT?
   - **Recommendation**: Claude Haiku (faster, cheaper, structured output)

2. **Default preset**: TikTok, Instagram, or YouTube?
   - **Recommendation**: TikTok (most dramatic, best for short-form)

3. **Always generate both SRT + ASS?**
   - **Recommendation**: Yes (max compatibility, small overhead)

4. **Focus word detection**: Automatic or optional?
   - **Recommendation**: Optional checkbox (costs LLM API calls)

---

## üìö Resources

- **ASS Format Spec**: https://github.com/libass/libass/wiki/ASS-File-Format
- **Aegisub (ASS Editor)**: https://aegisub.org
- **FFmpeg ASS Filter**: https://ffmpeg.org/ffmpeg-filters.html#ass
- **Anthropic Claude API**: https://docs.anthropic.com/claude/reference/messages_post

---

**Status**: Ready to implement
**Next**: See `ASS_CAPTIONS_EXECUTION.md` for step-by-step progress tracking
