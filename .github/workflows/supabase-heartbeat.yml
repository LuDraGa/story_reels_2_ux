name: Supabase Heartbeat

# Runs every 5 days to prevent Supabase Free tier from pausing (7-day threshold)
on:
  schedule:
    - cron: '0 12 */5 * *'  # Every 5 days at 12:00 UTC
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  heartbeat:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase Database
        id: ping
        run: |
          echo "üîÑ Sending heartbeat to Supabase..."

          response=$(curl -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/heartbeat" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            -w "\nHTTP_CODE:%{http_code}" \
            -s)

          http_code=$(echo "$response" | grep HTTP_CODE | cut -d: -f2)
          body=$(echo "$response" | grep -v HTTP_CODE)

          echo "üìä Response Body: $body"
          echo "üì° HTTP Status: $http_code"

          if [ "$http_code" != "200" ]; then
            echo "::error::‚ùå Heartbeat failed with HTTP $http_code"
            exit 1
          fi

          echo "::notice::‚úÖ Heartbeat successful - Database is alive"

      - name: Handle Failure
        if: failure()
        run: |
          echo "::warning::‚ö†Ô∏è Supabase heartbeat failed. Check:"
          echo "  1. SUPABASE_URL secret is correct"
          echo "  2. SUPABASE_ANON_KEY secret is correct"
          echo "  3. Database is not paused manually"
          echo "  4. Migration 20260209000000_heartbeat.sql was applied"
